---
title: "Bumblebees"
author: "Peter Menzies"
date: "11/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(janitor)
library(sf)
library(tmap)
library(snakecase)
library(leaflet)
library(tigris)
library(gstat)
library(sp)
```


```{r}
bumblebees <- read_csv("data/bumble_bee_occurrence.csv") %>% 
  clean_names() %>% 
  unite("date", year:day, sep = "-", remove = F) %>% 
  filter(between(year, 2002, 2010)) %>% 
  mutate(county = to_snake_case(county))
```



```{r}
bumble_state <- bumblebees %>% 
  group_by(state_province) %>% 
  count()
```

```{r}
bumble_county <- bumblebees %>% 
  group_by(state_province, county) %>% 
  count()
```


```{r}
bumble_sf <- bumblebees %>% 
  filter(!is.na(verbatim_longitude)) %>%
  filter(!is.na(verbatim_latitude)) %>% 
  st_as_sf(coords = c("verbatim_longitude", "verbatim_latitude"), crs = 4326)

bbox <- st_bbox(bumble_sf)


tm_shape(bumble_sf) +
  tm_dots(col = 'year')
```

```{r}
ca <- county_subdivisions("CA") %>% 
  select(NAME, geometry)
```


```{r}
bumble_sf_ca <- bumble_sf %>% 
  filter(state_province == "California")
  
tm_shape(bumble_sf_ca) +
  tm_dots() + 
  tm_shape(ca) +
  tm_polygons()
```

### Determine mean number of colonies per county between 2002 and 2012

```{r}
honeybee_county <- read.csv("data/Bee Colony Census Data by County.csv") %>% 
  clean_names() %>% 
  mutate(value = as.numeric(gsub(",", "", value))) %>% 
  mutate(county = to_snake_case(county))

colonies_by_county <- honeybee_county %>% 
  filter(!is.na(value)) %>% 
  group_by(year, county) %>% 
  summarize(colonies = sum(value))

surveys <- colonies_by_county %>% 
  group_by(county) %>% 
  count()

honey_means <- colonies_by_county %>% 
  group_by(county) %>% 
  summarize(total_colonies = sum(colonies)) %>% 
  add_column(surveys = surveys$n) %>% 
  mutate(mean_colonies = total_colonies / surveys)
```

### Joining bumble and honey

```{r}
bees_joined <- bumble_county %>% 
  left_join(honey_means, by = "county")
```



```{r}
lm(n ~ total_colonies, bees_joined) %>% summary()
```




```{r}
bumble_sf_years <- bumble_sf %>% 
  group_by(year) %>% 
  count() %>% 
  filter(year > 1900)
```


## US Bombus dataset


```{r}
bombus <- read_tsv("data/us_bombus.csv") %>% 
  clean_names()

bombus_totals <- bombus %>% 
  filter(state_province != "Alaska") %>% 
  group_by(decimal_latitude, decimal_longitude) %>% 
  summarize(n = sum(individual_count))

bombus_sf <- bombus_totals %>% 
  filter(!is.na(decimal_latitude) & !is.na(decimal_longitude)) %>% 
  st_as_sf(coords = c("decimal_longitude", "decimal_latitude"),
           crs = 4269)

tm_shape(all_bombus_sf) +
  tm_dots(col = 'n',
          size = 0.5,
          palette = 'plasma',
          alpha = 0.5)
```


```{r}
bombus_vgram <- variogram(n~1, as(all_bombus_sf, "Spatial"))

plot(bombus_vgram)
```

```{r}
vgram_model_full <- automap::autofitVariogram(n ~ 1, as(all_bombus_sf, "Spatial"))

vgram_model <- vgram_model_full$var_model

plot(vgram_model_full)
```

```{r}
grid_sf <- new_bbox %>%  
  st_as_sfc() %>%
  st_make_grid(cellsize = c(0.4, 0.4), what = "centers") %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.))
```



```{r}
grid_sp <- as(grid_sf, "Spatial") # converting to {sp} format
gridded(grid_sp) <- TRUE             # informing the object that it is a grid
grid_sp <- as(grid_sp, "SpatialPixels") # specifying what kind of grid
```


```{r}
new_bbox <- st_bbox(c("xmin" = -126,
                      "ymin" = 19,
                      "xmax" = -65,
                      "ymax" = 50),
                    crs = 4269)

st_bbox(bombus_sf)
```


```{r}
krige <- krige(
  n ~ 1,                       # Z is our variable and "~1" means "depends on mean"
  as(all_bombus_sf, "Spatial"), # input data in {sp} format
  grid_sp,                # locations to interpolate at
  model = vgram_model           # the variogram model fitted above
  )
```

```{r}
us_outline <- tigris::states() %>% 
  dplyr::select(geometry) %>% 
  st_combine() %>% 
  st_make_valid() %>% 
  st_as_sf(crs = 4269)
```


```{r}
tm_shape(krige_raster) +
  tm_raster(col = "var1.pred", palette = "plasma", style = "cont", title = "") +
  tm_shape(us_outline) +
  tm_borders(lwd = 1, col = "white") +
  tm_layout(main.title = "Interpolated Bombus occurrence in the United States",
            legend.position = c("left", "bottom"))
```


```{r}
krige_raster <- raster(krige)

krige_df <- rasterToPoints(krige_raster) %>% as_tibble()

krige_sf <- krige_df %>% 
  st_as_sf(coords = c("x", "y"),
           crs = 4269) %>% 
  rename(pred_occurrence = var1.pred)
  
```


```{r}
krige_counties <- krige_sf %>% 
  st_join(state_county_geoms, join = st_intersects) %>% 
  filter(!is.na(county))
  
krige_means <- krige_counties %>% 
  group_by(county, state_name) %>% 
  summarize(mean_pred_occurrence = mean(pred_occurrence))
```

```{r}
krige_joined <- krige_means %>% 
  inner_join(colony_means, by = c("state_name" = "state", "county" = "county"))
```

```{r}
ggplot(krige_joined, aes(x = mean_colonies, y = mean_pred_occurrence)) +
  geom_point() +
  geom_smooth(method = "lm")
```


```{r}
lm(mean_pred_occurrence ~ mean_colonies, krige_joined) %>% summary()

```


```{r}
# regression
model_krige <- lm(mean_pred_occurrence ~ mean_colonies, data = krige_joined)

# create predictions and residuals
predictions_krige <- krige_joined %>%
  modelr::add_predictions(model_krige) %>%
  mutate(residuals = mean_pred_occurrence - pred)

ggplot(predictions_krige, aes(x = mean_colonies, y = residuals)) +
  geom_point(alpha = 0.5)

```


```{r}
bumble_totals <- bumblebees %>% 
  filter(state_province != "Alaska") %>% 
  group_by(verbatim_latitude, verbatim_longitude) %>% 
  count() %>% 

all_bombus <- bombus_totals %>% 
  full_join(bumble_totals, by = c("decimal_latitude" = "verbatim_latitude", 
                                  "decimal_longitude" = "verbatim_longitude")) %>% 
  mutate(n = sum(c(n.x, n.y), na.rm = TRUE)) %>% 
  dplyr::select(decimal_latitude, decimal_longitude, n)

all_bombus_sf <- all_bombus %>% 
  filter(!is.na(decimal_latitude) & !is.na(decimal_longitude)) %>% 
  st_as_sf(coords = c("decimal_longitude", "decimal_latitude"),
           crs = 4269)
```

