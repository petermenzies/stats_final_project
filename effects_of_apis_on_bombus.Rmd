---
title: "Potential impacts of managed honeybee colonies on Bombus occurrence in US counties"
author: "Peter Menzies"
date: "11/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(sf)
library(tmap)
library(snakecase)
library(leaflet)
library(tigris)
library(DescTools)
```

## Question and background

## Data

## Reading in and wrangling

### Honeybees

```{r}
honeybees <- read.csv("data/Bee Colony Census Data by County.csv") %>% 
  clean_names() %>% 
  mutate(value = as.numeric(gsub(",", "", value))) %>% 
  mutate(county = to_snake_case(county)) %>% 
  mutate(state = str_to_title(state))

colonies_by_county <- honeybees %>% 
  filter(!is.na(value)) %>% 
  group_by(year, county, state) %>% 
  summarize(colonies = sum(value))

surveys <- colonies_by_county %>% 
  group_by(county, state) %>% 
  count()

colony_means <- colonies_by_county %>% 
  group_by(county, state) %>% 
  summarize(total_colonies = sum(colonies)) %>% 
  add_column(surveys = surveys$n) %>% 
  mutate(mean_colonies = total_colonies / surveys)
```

### Bumblebees

#### Bumblebee dataset 1 — Data from: _Patterns of Widespread Decline in North American Bumble Bees_

```{r}
bumblebees <- read_csv("data/bumble_bee_occurrence.csv") %>% 
  clean_names() %>% 
  unite("date", year:day, sep = "-", remove = F) %>% 
  filter(between(year, 2002, 2010)) %>% 
  mutate(county = to_snake_case(county))
```

```{r}
bumble_by_county <- bumblebees %>% 
  group_by(state_province, county) %>% 
  count()
```

#### Bumblebee dataset 2 — _USBombus: contemporary survey data of North American bumble bees (Hymenoptera, Apidae, Bombus) distributed in the United States_

```{r}
bombus <- read_tsv("data/us_bombus.csv") %>% 
  clean_names()
```

Our `bombus` dataset doesn't include the county that each observation was taken in, but it _does_ provide a latitude and longitude—so, we'll have to use those to bootstrap a spatial dataframe, and perform a spatial join with US county data. 

First we'll create our spatial dataframe.

```{r}
bombus_sf <- bombus %>% 
  st_as_sf(coords = c("decimal_longitude", "decimal_latitude"), crs = "NAD83")
```

Then we'll create a dataframe containing the spatial bounds of US counties using the `tigris` package.

```{r}
counties <- counties() %>% 
  select(NAME, STATEFP, COUNTYFP, geometry) %>% 
  rename(county = NAME, county_code = COUNTYFP) %>% 
  mutate(county = to_snake_case(county))
```

```{r}
bombus_counties <- st_join(bombus_sf, counties, join = st_intersects)
```

```{r}
bombus_by_county <- bombus_counties %>%
  as.data.frame %>% 
  group_by(state_province, county) %>% 
  summarize(n2 = sum(individual_count))
```

#### Joining dataframes

```{r}
bumble_joined <- bumble_by_county %>% 
  full_join(bombus_by_county, by = c("state_province" = "state_province", "county" = "county")) %>%
  mutate(bumble_counts = sum(c(n, n2), na.rm = TRUE))
```

```{r}
all_joined <- bumble_joined %>% 
  left_join(colony_means, by = c("state_province" = "state", "county" = "county")) %>% 
  as.data.frame() %>% 
  filter(!is.na(mean_colonies))
```


## Chloropleths for funsies

```{r}
fips <- fips_codes %>% 
  select(state_code, state_name) %>% 
  rename(STATEFP = state_code) %>% 
  distinct()

state_county_geoms <- counties %>% 
  left_join(fips, by = "STATEFP")

# restoring geometries of counties
all_joined_sf <- state_county_geoms %>% 
  left_join(all_joined, by = c("state_name" = "state_province", "county" = "county")) %>% 
  filter(!is.na(mean_colonies) & !is.na(bumble_counts))
```

```{r}
tm_shape(all_joined_sf) +
  tm_polygons(col = "bumble_counts",
              palette = "YlGn",
              style = "cont",
              breaks = seq(0, 2000, 250))
```

```{r}
tm_shape(all_joined_sf) +
  tm_polygons(col = "mean_colonies", )
```

```{r}
ggplot(all_joined, aes(x = log(bumble_counts))) +
  geom_histogram()
```
```{r}
ggplot(all_joined, aes(x = log(mean_colonies))) +
  geom_histogram()
```


## Plotting and Regression

```{r}
bombus_on_apis <- ggplot(all_joined, aes(x = mean_colonies, y = bumble_counts)) +
  geom_point() +
  geom_smooth(method = "lm")

bombus_on_apis
```
```{r}
bumble_99 <- quantile(all_joined$bumble_counts, 0.99)
colony_99 <- quantile(all_joined$mean_colonies, 0.99)

all_joined_winsorized <- all_joined %>% 
  mutate(bumble_counts = Winsorize(bumble_counts, maxval = bumble_99),
         mean_colonies = Winsorize(mean_colonies, maxval = colony_99))
```

```{r}
bombus_apis_winsor <- ggplot(all_joined_winsorized, aes(x = mean_colonies, y = bumble_counts)) +
  geom_point() +
  geom_smooth(method = "lm")

bombus_apis_winsor
```

```{r}
apis_bombus_regression <- lm(bumble_counts ~ mean_colonies, all_joined) %>% 
  summary()
apis_bombus_regression
```
```{r}
apis_bombus_winsor_regression <- lm(bumble_counts ~ mean_colonies, all_joined_winsorized) %>% 
  summary()
apis_bombus_winsor_regression
```

```{r}
# regression
model <- lm(bumble_counts ~ mean_colonies, data = all_joined)

# create predictions and residuals
predictions <- all_joined %>%
  modelr::add_predictions(model) %>%
  mutate(residuals = bumble_counts-pred)

ggplot(predictions, aes(x = mean_colonies, y = residuals)) +
  geom_point(alpha = 0.5)

```


## Conclusions and takeaways






