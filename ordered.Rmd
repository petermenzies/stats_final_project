---
title: "Untitled"
author: "Peter Menzies"
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(sf)
library(tmap)
library(snakecase)
library(leaflet)
library(tigris)
library(gstat)
library(sp)
library(sjPlot)

```

## Background

Pollinator decline is among the world’s most pressing environmental issues. The creatures that fill this niche are necessary for the reproduction of roughly 85% of flowering plant species, and about three-fourths of the world’s staple crop species rely on them (US Forest Service). The services that pollinators provide in the US agricultural system were valued at $34 in 2012 (Jordan et al. 2021). That staggering figure doesn’t even include the value of the many ecosystems that hinge on their presence. Honeybees have become the poster child of this issue—and while the attention is well-deserved, the US is home to around 4000 native bee species, many of which are also facing population declines and are also highly important pollinators (US Forest Service). 49 of these are bumblebees, members of the genus Bombus. In addition to their general efficacy as pollen carriers, bumblebees are the sole pollinators of certain plants they have coevolved with. Flowers of plants like blueberries, tomatoes, pumpkins, and many others require what’s known as buzz pollination, or sonication—this means they need a bee to vibrate at a particular frequency to release their pollen (Vallejo-Marín 2019). Bombus species perform this form of pollination, making them invaluable to our native ecosystems and many important food crops.

Interestingly, some studies have shown evidence that managed honeybees, which are nonnative, may be outcompeting native bees for resources (Angelella, McCullough, and O’Rourke 2021)(Mallinger, Gaines-Day, and Gratton 2017). It’s crucial that we understand everything that might be contributing to the decline of native bee species. The goal of this analysis is to investigate the possible relationship between the number of managed honeybee colonies and the instances of bumblebee occurrence within the US.

## Data

The analysis uses two different datasets—one containing managed honeybee colonies and the other bumblebee occurrence. 

The honeybee data are originally from the USDA, and were tidied and made available on data.world by Brenda Grifith. The full dataset can be found here: https://data.world/siyeh/us-bee-stats-by-state/workspace/file?filename=Bee+Colony+Census+Data+by+County.csv. It contains the number of managed honeybee hives reported to the USDA Census of Agriculture per US county, in 2002, 2007, and 2012. 

The bumblebee data are the result of a systematic nationwide survey of Bombus populations conducted for a 2011 study by Cameron et al. to determine the extent of bumblebee decline in the US. The dataset can be found here: https://www.gbif.org/dataset/c4a2c617-91a7-4d4f-90dd-a78b899f8545#temporalCoverages.  It contains observations of bumblebee occurrence from sites in 40 of the contiguous states throughout a range of habitats and elevations, and includes coordinates associated with each observation. Specimens were captured on flowers and in flight using sweep nets. The survey took place between 2007 and 2010. 

## Methods

I chose to compare variations in honeybee colonies and bumblebee occurrence by location because the bumblebee data were collected over a number of years with little to no overlap in survey sites—thus, they don’t allow us to observe variation over time.

Because insect population densities can vary over small spatial ranges, I wanted to compare honeybee colonies and bumblebee occurrence at the finest resolution possible. In this case, the honeybee colony dataset limits us to the county level. 

### Dataset Approaches

In order to capture estimates of the number of managed honeybee colonies in the years surrounding the bumblebee survey, I calculated the mean number of colonies reported for each county from agriculture census years 2002, 2007, and 2012. Data from states that weren’t surveyed in USBombus were removed.

```{r, echo=F}
# states not surveyed in USBombus
missing_states <- c("Delaware", "Florida", "Hawaii", "Maryland", "Michigan", "New Hampshire", "New Jersey", "Rhode Island", "West Virginia")

honeybees <- read.csv("data/Bee Colony Census Data by County.csv") %>% 
  clean_names() %>% 
  mutate(value = as.numeric(gsub(",", "", value))) %>% 
  mutate(county = to_snake_case(county)) %>% 
  mutate(state = str_to_title(state)) %>% 
  filter(!state %in% missing_states)

colonies_by_county <- honeybees %>% 
  filter(!is.na(value)) %>% 
  group_by(year, county, state) %>% 
  summarize(colonies = sum(value))

surveys <- colonies_by_county %>% 
  group_by(county, state) %>% 
  count()

colony_means <- colonies_by_county %>% 
  group_by(county, state) %>% 
  summarize(total_colonies = sum(colonies)) %>% 
  add_column(surveys = surveys$n) %>% 
  mutate(mean_colonies = total_colonies / surveys / 1000)
```

Despite being one of the most extensive US bee surveys available, the USBombus data only represent occurrence in certain parts of certain counties. In order to estimate a more complete picture of bumblebee occurrence at the county level throughout much of the country, I chose to interpolate bumblebee occurrence using the survey data. Based on its spatial dispersion, the dataset appears to be a good candidate for this approach. I used ordinary Kriging, which several studies have successfully employed to predict insect occurrence (Pasini et al. 2021)(Zhang et al. 2007)(Zhou et al. 2012). To simplify the interpolation process, I limited the analysis to only counties within the conterminous US. 

```{r}
bombus <- read_tsv("data/us_bombus.csv") %>% 
  clean_names()

bombus_totals <- bombus %>% 
  filter(state_province != "Alaska") %>% 
  group_by(decimal_latitude, decimal_longitude) %>% 
  summarize(n = sum(individual_count))

bombus_sf <- bombus_totals %>% 
  filter(!is.na(decimal_latitude) & !is.na(decimal_longitude)) %>% 
  st_as_sf(coords = c("decimal_longitude", "decimal_latitude"),
           crs = 4269)

tm_shape(bombus_sf) +
  tm_dots(col = 'n',
          size = 0.5,
          palette = 'plasma',
          alpha = 0.5)
```

### Interpolation

After summing the occurrence counts at each unique latitude and longitude in the bumblebee dataset, I used the `autofitVariogram` function in the `automap` package to create a fitted variogram model. I then created a grid with the spatial bounds of the bumblebee dataset composed of 0.4° x 0.4° cells. Using the `krige()` function in the `gstats` package I interpolated values of bumblebee occurrence onto the grid based on the variogram model. In order to derive a single estimated value of bumblebee occurrence in each county, I joined the interpolated output with a US counties dataset, and calculated the mean predicted occurrence in each county. I subsetted the resulting data to only states that were surveyed and only counties for which honeybee data was available by performing an inner join with the honeybee dataset. The interpolated mean bumblebee occurrence data are visualized below.

```{r}
#----

bombus_vgram <- variogram(n ~ 1, as(bombus_sf, "Spatial"))

plot(bombus_vgram)

vgram_model_full <- automap::autofitVariogram(n ~ 1, as(bombus_sf, "Spatial"))

vgram_model <- vgram_model_full$var_model

plot(vgram_model_full)

#----

grid_sf <- bombus_sf %>% 
  st_bbox %>% 
  st_as_sfc() %>%
  st_make_grid(cellsize = c(0.4, 0.4), what = "centers") %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.))

grid_sp <- as(grid_sf, "Spatial") # converting to {sp} format
gridded(grid_sp) <- TRUE             # informing the object that it is a grid
grid_sp <- as(grid_sp, "SpatialPixels") # specifying what kind of grid

#----

krige <- krige(
  n ~ 1,                       # Z is our variable and "~1" means "depends on mean"
  as(bombus_sf, "Spatial"), # input data in {sp} format
  grid_sp,                # locations to interpolate at
  model = vgram_model           # the variogram model fitted above
  )

#----

krige_raster <- raster::raster(krige)

krige_df <- raster::rasterToPoints(krige_raster) %>% as_tibble()

krige_sf <- krige_df %>% 
  st_as_sf(coords = c("x", "y"),
           crs = 4269) %>% 
  rename(pred_occurrence = var1.pred)

#----

us_outline <- tigris::states() %>% 
  select(geometry) %>% 
  st_combine() %>% 
  st_make_valid() %>% 
  st_as_sf(crs = 4269)

#----

counties <- counties() %>% 
  dplyr::select(NAME, STATEFP, COUNTYFP, geometry) %>% 
  rename(county = NAME, county_code = COUNTYFP) %>% 
  mutate(county = to_snake_case(county))

fips <- fips_codes %>% 
  dplyr::select(state_code, state_name) %>% 
  rename(STATEFP = state_code) %>% 
  distinct()

state_county_geoms <- counties %>% 
  left_join(fips, by = "STATEFP")

#----

krige_counties <- krige_sf %>% 
  st_join(state_county_geoms, join = st_intersects) %>% 
  filter(!is.na(county))
  
krige_means <- krige_counties %>% 
  group_by(county, state_name) %>% 
  summarize(mean_pred_occurrence = mean(pred_occurrence))

#----

new_bbox <- st_bbox(c("xmin" = -126,
                      "ymin" = 24,
                      "xmax" = -65,
                      "ymax" = 50),
                    crs = 4269)

#----

krige_joined <- colony_means %>% 
  inner_join(krige_means, by = c("state" = "state_name", "county" = "county")) %>% 
  st_as_sf(crs = 4269)

tm_shape(krige_joined, bbox = new_bbox) +
  tm_dots(col = "mean_pred_occurrence",
          shape = 22,
          border.lwd = 0,
          size = 0.175,
          style = "cont",
          palette = "plasma",
          title = "") +
  tm_layout(main.title = "Interpolated Bombus occurrence in the United States") +
  tm_shape(us_outline) +
  tm_borders(lwd = 1.5)
```

```{r, eval=FALSE}
ggplot(krige_joined, aes(x = mean_pred_occurrence)) +
  geom_histogram()

ggplot(krige_joined, aes(x = log(mean_colonies))) +
  geom_histogram()
```



```{r}
ggplot(krige_joined, aes(x = mean_colonies, y = mean_pred_occurrence)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_minimal()
```


```{r}
model_summary <- lm(mean_pred_occurrence ~ mean_colonies, krige_joined) %>%
  summary()

tab_model(model_summary, dv.labels = "Mean predicted Bombus occurrence")
```

```{r}
model <- lm(mean_pred_occurrence ~ mean_colonies, krige_joined)

# create predictions and residuals
predictions <- krige_joined %>%
  modelr::add_predictions(model) %>%
  mutate(residuals = mean_pred_occurrence - pred)

mean(predictions$residuals)

ggplot(predictions, aes(x = mean_colonies, y = residuals)) +
  geom_point(alpha = 0.5)
```


