---
title: "Untitled"
author: "Peter Menzies"
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(sf)
library(tmap)
library(snakecase)
library(leaflet)
library(tigris)
library(gstat)
library(sp)
```

## Question and background

Pollinator decline is among the world’s most pressing environmental issues. The many creatures that fill this niche are necessary for the reproduction of roughly 85% of flowering plant species, including about two-thirds of the world’s crop species. The services that pollinators provide in the US agricultural system is valued at $24 billion a year—not to mention the many ecosystems that hinge on their presence. Honeybees have become the poster child of this issue—and while the attention is well-deserved, the US is home to around 4000 native bee species, many of which are also facing population declines and are important pollinators. 49 of these are bumblebees, members of the genus Bombus, are among the most prolific and successful pollinators. In addition to their general efficacy as pollen carriers, bumblebees are the sole pollinators of certain plants they have coevolved with. Flowers of plants like blueberries, tomatoes, pumpkins, and many others require what’s known as buzz pollination, or sonication—this means they need a bee to vibrate at a particular frequency to release its pollen. Bombus species perform this form of pollination, making them invaluable to our native ecosystems and many important food crops.

Interestingly, some studies have shown evidence that honeybees, which are nonnative, may be outcompeting native bees in some instances. It’s crucial that we understand everything that might be contributing to the decline of native bee species. The goal of this analysis is to investigate the possible relationship between the number of managed honeybee colonies and the instances of bumblebee occurrence within US counties. 

## Data

The analysis will use two different datasets

## Reading in and wrangling

### Honeybees

```{r}
# states not surveyed in USBombus
missing_states <- c("Delaware", "Florida", "Hawaii", "Maryland", "Michigan", "New Hampshire", "New Jersey", "Rhode Island", "West Virginia")

honeybees <- read.csv("data/Bee Colony Census Data by County.csv") %>% 
  clean_names() %>% 
  mutate(value = as.numeric(gsub(",", "", value))) %>% 
  mutate(county = to_snake_case(county)) %>% 
  mutate(state = str_to_title(state)) %>% 
  filter(!state %in% missing_states)

colonies_by_county <- honeybees %>% 
  filter(!is.na(value)) %>% 
  group_by(year, county, state) %>% 
  summarize(colonies = sum(value))

surveys <- colonies_by_county %>% 
  group_by(county, state) %>% 
  count()

colony_means <- colonies_by_county %>% 
  group_by(county, state) %>% 
  summarize(total_colonies = sum(colonies)) %>% 
  add_column(surveys = surveys$n) %>% 
  mutate(mean_colonies = total_colonies / surveys / 1000)
```

### Bumblebees

#### Data from — _USBombus: contemporary survey data of North American bumble bees (Hymenoptera, Apidae, Bombus) distributed in the United States_


```{r}
bombus <- read_tsv("data/us_bombus.csv") %>% 
  clean_names()

bombus_totals <- bombus %>% 
  filter(state_province != "Alaska") %>% 
  group_by(decimal_latitude, decimal_longitude) %>% 
  summarize(n = sum(individual_count))

bombus_sf <- bombus_totals %>% 
  filter(!is.na(decimal_latitude) & !is.na(decimal_longitude)) %>% 
  st_as_sf(coords = c("decimal_longitude", "decimal_latitude"),
           crs = 4269)
```

Next, let's get some perspective on how the Bombus occurrence data are dispersed

```{r}
tm_shape(bombus_sf) +
  tm_dots(col = 'n',
          size = 0.5,
          palette = 'plasma',
          alpha = 0.5)
```


```{r}
bombus_vgram <- variogram(n ~ 1, as(bombus_sf, "Spatial"))

plot(bombus_vgram)
```

```{r}
vgram_model_full <- automap::autofitVariogram(n ~ 1, as(bombus_sf, "Spatial"))

vgram_model <- vgram_model_full$var_model

plot(vgram_model_full)
```


```{r}
grid_sf <- bombus_sf %>% 
  st_bbox %>% 
  st_as_sfc() %>%
  st_make_grid(cellsize = c(0.4, 0.4), what = "centers") %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.))
```

```{r}
grid_sp <- as(grid_sf, "Spatial") # converting to {sp} format
gridded(grid_sp) <- TRUE             # informing the object that it is a grid
grid_sp <- as(grid_sp, "SpatialPixels") # specifying what kind of grid
```


```{r}
krige <- krige(
  n ~ 1,                       # Z is our variable and "~1" means "depends on mean"
  as(bombus_sf, "Spatial"), # input data in {sp} format
  grid_sp,                # locations to interpolate at
  model = vgram_model           # the variogram model fitted above
  )
```

```{r}
krige_raster <- raster::raster(krige)

krige_df <- raster::rasterToPoints(krige_raster) %>% as_tibble()

krige_sf <- krige_df %>% 
  st_as_sf(coords = c("x", "y"),
           crs = 4269) %>% 
  rename(pred_occurrence = var1.pred)
```

```{r}
us_outline <- tigris::states() %>% 
  dplyr::select(geometry) %>% 
  st_combine() %>% 
  st_make_valid() %>% 
  st_as_sf(crs = 4269)
```

```{r}
# Taking a look at the interpolated raster
tm_shape(krige_raster) +
  tm_raster(col = "var1.pred", palette = "plasma", style = "cont", title = "") +
  tm_shape(us_outline) +
  tm_borders(lwd = 1, col = "white") +
  tm_layout(main.title = "Interpolated Bombus occurrence in the United States",
            legend.position = c("left", "bottom"))
```

```{r}
counties <- counties() %>% 
  dplyr::select(NAME, STATEFP, COUNTYFP, geometry) %>% 
  rename(county = NAME, county_code = COUNTYFP) %>% 
  mutate(county = to_snake_case(county))

fips <- fips_codes %>% 
  dplyr::select(state_code, state_name) %>% 
  rename(STATEFP = state_code) %>% 
  distinct()

state_county_geoms <- counties %>% 
  left_join(fips, by = "STATEFP")
```


```{r}
krige_counties <- krige_sf %>% 
  st_join(state_county_geoms, join = st_intersects) %>% 
  filter(!is.na(county))
  
krige_means <- krige_counties %>% 
  group_by(county, state_name) %>% 
  summarize(mean_pred_occurrence = mean(pred_occurrence))
```

```{r}
new_bbox <- st_bbox(c("xmin" = -126,
                      "ymin" = 24,
                      "xmax" = -65,
                      "ymax" = 50),
                    crs = 4269)
```

```{r}
krige_joined <- colony_means %>% 
  inner_join(krige_means, by = c("state" = "state_name", "county" = "county")) %>% 
  st_as_sf(crs = 4269)

tm_shape(krige_joined, bbox = new_bbox) +
  tm_dots(col = "mean_pred_occurrence",
          shape = 22,
          border.lwd = 0,
          size = 0.175,
          style = "cont",
          palette = "plasma",
          title = "") +
  tm_layout(main.title = "Interpolated Bombus occurrence in the United States") +
  tm_shape(us_outline) +
  tm_borders(lwd = 1.5)
```

```{r}
ggplot(krige_joined, aes(x = mean_colonies, y = mean_pred_occurrence)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_minimal()
```


```{r}
lm(mean_pred_occurrence ~ mean_colonies, krige_joined) %>% summary()

```




